#!/bin/bash

EMBEDDED_RUBY=true
CONFIG_FILE=/etc/sensu/config.json
CONFIG_DIR=/etc/sensu/conf.d
EXTENSION_DIR=/etc/sensu/extensions
PLUGINS_DIR=/etc/sensu/plugins
HANDLERS_DIR=/etc/sensu/handlers
LOG_DIR=<%= node['chef_server']['sensu']['log_directory'] %>

if [ -f /etc/default/sensu ]; then
    . /etc/default/sensu
fi

prog="sensu-client"
options="-c $CONFIG_FILE -d $CONFIG_DIR -e $EXTENSION_DIR -l $LOG_DIR/$prog.log $OPTIONS"

# $ORIGINAL_PATH is set by sensu-runsvdir
if [ "x$EMBEDDED_RUBY" = "xtrue" ]; then
    export PATH=/opt/chef-server/embedded/bin:$PATH:$PLUGINS_DIR:$HANDLERS_DIR
    export GEM_PATH=/opt/chef-server/embedded/lib/ruby/gems/1.9.1:$GEM_PATH
else
    export PATH=$PATH:$PLUGINS_DIR:$HANDLERS_DIR
fi

exec 2>&1
exec chpst -U <%= node['chef_server']['user']['username1'] %> -u <%= node['chef_server']['user']['username1'] %> /opt/chef-server/embedded/bin/$prog $options
