#!/bin/bash

# Force all stderr to stdout
exec 2>&1

# Where does elasticsearch live?
export ES_HOME=/opt/chef-server/embedded/service/elasticsearch
export ES_CONF_DIR=/opt/chef-server/embedded/service/elasticsearch/config
export ES_INCLUDE=$ES_HOME/bin/elasticsearch.in.sh
export JAVA_HOME=/opt/chef-server/embedded/jre

# Where does data live?
ES_DATA_ROOT=<%= node['chef_server']['elasticsearch']['dir'] %>
export ES_DATA_DIR=$ES_DATA_ROOT/data
export ES_WORK_DIR=$ES_DATA_ROOT/work

# bump the # of open files way way up
ulimit -n 65536

ulimit -a

# Force the heap size
export ES_MIN_MEM=<%= node['chef_server']['elasticsearch']['memory'] %>
export ES_MAX_MEM=<%= node['chef_server']['elasticsearch']['memory'] %>

# Run in non-daemonizing mode
cd $ES_HOME
exec chpst -P -U <%= node['chef_server']['user']['username1'] %> -u <%= node['chef_server']['user']['username1'] %> /usr/bin/env PATH=/opt/chef-server/embedded/bin:/opt/chef-server/bin:/opt/chef-server/embedded/jre/bin:$PATH JAVA_HOME=/opt/chef-server/embedded/jre /opt/chef-server/embedded/bin/elasticsearch \
  -Des.config=$ES_CONF_DIR/elasticsearch.yml -f
